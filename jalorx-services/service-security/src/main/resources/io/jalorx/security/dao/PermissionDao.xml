<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="io.jalorx.security.dao.PermissionDao">

	<!-- <cache /> -->
	<resultMap type="io.jalorx.security.entity.PermissionVO" id="permissionMap">
		<result property="code" column="CODE" />
		<result property="desc" column="DESP" />
		<result property="parent_code" column="PARENT_CODE" />
		<result property="app_code" column="APP_CODE" />
	</resultMap>
	<resultMap type="io.jalorx.boot.model.SimpleRowRule" id="SimpleRowRuleMap">
		<result property="code" column="CODE" />
		<result property="defaultField" column="DEFAULT_FIELD" />
		<result property="type" column="DATA_TYPE" />
		<result property="operator" column="SQL_OPERATOR" />
		<result property="values" column="DATA_VALUES" />
	</resultMap>
	
	

	<!-- ///////////////////////////基础接口定义///////////////////////////////// -->
	<select id="getById" resultMap="permissionMap">
		SELECT
		T.*
		FROM
		(
		SELECT
		t.ID,
		CONCAT(P.APP_CODE,".",p.CODE,".",t. CODE) as CODE,
		t.DESP,
		p. CODE AS
		PARENT_CODE,
		P.APP_CODE
		FROM
		tpl_perm_oper_t t
		LEFT JOIN
		tpl_perm_resource_t p ON t.PARENT_ID = p.ID
		) T

		WHERE T.ID = #{id}
		ORDER
		BY
		T.APP_CODE,
		T.PARENT_CODE,
		T. CODE
	</select>


	<select id="getByIds" resultMap="permissionMap">
		SELECT
		T.*
		FROM
		(
		SELECT
		t.ID,
		CONCAT(P.APP_CODE,".",p.CODE,".",t. CODE) as
		CODE,
		t.DESP,
		p. CODE AS PARENT_CODE,
		P.APP_CODE
		FROM
		tpl_perm_oper_t t
		LEFT JOIN tpl_perm_resource_t p ON t.PARENT_ID = p.ID
		) T

		WHERE T.ID in
		<foreach item="id" collection="ids" open="(" separator=","
			close=")">
			#{id}
		</foreach>
		ORDER BY
		T.APP_CODE,
		T.PARENT_CODE,
		T. CODE
	</select>

	<select id="getCount" resultType="int">
		SELECT
		count(1)
		FROM
		(
		SELECT
		t.ID,
		CONCAT(P.APP_CODE,".",p.CODE,".",t.
		CODE) as CODE,
		t.DESP,
		p. CODE AS PARENT_CODE,
		P.APP_CODE
		FROM
		tpl_perm_oper_t t
		LEFT JOIN tpl_perm_resource_t p ON t.PARENT_ID = p.ID
		) T
		<filter open="where (" close=")" />
		ORDER BY
		T.APP_CODE,
		T.PARENT_CODE,
		T. CODE
	</select>

	<select id="selectAll" resultMap="permissionMap">
		SELECT
		T.*
		FROM
		(
		SELECT
		t.ID,
		CONCAT(P.APP_CODE,".",p.CODE,".",t. CODE) as
		CODE,
		t.DESP,
		p. CODE AS PARENT_CODE,
		P.APP_CODE
		FROM
		tpl_perm_oper_t t
		LEFT JOIN tpl_perm_resource_t p ON t.PARENT_ID = p.ID
		) T

		<filter open="where (" close=")" />
		ORDER BY
		T.APP_CODE,
		T.PARENT_CODE,
		T. CODE
	</select>

	<select id="select" pageable="true" resultMap="permissionMap">
		SELECT
		T.*
		FROM
		(
		SELECT
		t.ID,
		CONCAT(P.APP_CODE,".",p.CODE,".",t. CODE) as
		CODE,
		t.DESP,
		p. CODE AS PARENT_CODE,
		P.APP_CODE
		FROM
		tpl_perm_oper_t t
		LEFT JOIN tpl_perm_resource_t p ON t.PARENT_ID = p.ID
		) T

		<filter open="where (" close=")" />
		ORDER BY
		T.APP_CODE,
		T.PARENT_CODE,
		T. CODE
	</select>

	<!-- //////////////////////////////////////////////////////////// -->


	<delete id="delPermsByRoleId">
		DELETE FROM TPL_APP_ROLE_PERMS_T
		WHERE ROLE_ID = #{id}
	</delete>
	<delete id="delPermsByRoleIds">
		DELETE FROM TPL_APP_ROLE_PERMS_T
		WHERE ROLE_ID in
		<foreach item="id" collection="ids" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</delete>
	<insert id="insertPerms" databaseId="mysql">
		INSERT INTO TPL_APP_ROLE_PERMS_T VALUES
		<foreach item="perm" collection="perms" separator=",">
			(#{roleId},
			#{perm})
		</foreach>
	</insert>

	<insert id="insertPerms" databaseId="sqlserver">
		INSERT INTO TPL_APP_ROLE_PERMS_T VALUES
		<foreach item="perm" collection="perms" separator=",">
			(#{roleId},
			#{perm})
		</foreach>
	</insert>

	<insert id="insertPerms" databaseId="oracle">
		INSERT INTO TPL_APP_ROLE_PERMS_T
		<foreach item="perm" collection="perms" separator="union">
			(SELECT
			#{roleId}, #{perm} FROM DUAL)
		</foreach>
	</insert>


	<select id="getPermissionsByRoleId" resultType="string">
		SELECT
		T.CODE
		FROM
		TPL_APP_ROLE_PERMS_T T
		WHERE T.ROLE_ID = #{id}
	</select>

	<select id="findPermissionsByUserId" resultType="string">
		SELECT DISTINCT
		(T. CODE)
		FROM
		TPL_APP_ROLE_PERMS_T T
		WHERE
		T.ROLE_ID IN (
		SELECT
		T.ROLE_ID
		FROM
		TPL_USER_ROLE_T T,
		tpl_app_role_t R
		WHERE
		T.ROLE_ID = R.ID
		AND R.
		STATUS = 1
		AND T.USER_ID = #{userId}
		)
	</select>
	
	<select id="getDataRowRule" resultMap="SimpleRowRuleMap">
		SELECT
		T.*
		FROM
		TPL_DATA_ROW_RULE_T T
		WHERE T.DATA_RULE_ID = #{id}
	</select>

</mapper>

