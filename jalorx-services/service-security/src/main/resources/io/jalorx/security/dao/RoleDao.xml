<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.jalorx.security.dao.RoleDao">

	<!-- <cache /> -->
	
	<resultMap id="RuntimeRoleResultMap" type="io.jalorx.boot.model.RuntimeRole">
        <result column="ROLE_ID" jdbcType="INTEGER" property="roleID" javaType="int" />
        <result column="DATA_ID" jdbcType="INTEGER" property="dataID" javaType="int" />
	</resultMap>

	<!-- ///////////////////////////基础接口定义///////////////////////////////// -->

	<select id="getById"
		resultType="io.jalorx.security.entity.Role">
		SELECT
		T.*
		FROM TPL_APP_ROLE_T T
		WHERE T.ID = #{id}
	</select>

	<select id="getByIds"
		resultType="io.jalorx.security.entity.Role">
		SELECT
		T.*
		FROM TPL_APP_ROLE_T T
		WHERE T.ID in
		<foreach item="id" collection="ids" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</select>

	<select id="getCount" resultType="int">
		SELECT
		count(1)
		FROM TPL_APP_ROLE_T T
		<filter open="where (" close=")" />
	</select>

	<select id="selectAll"
		resultType="io.jalorx.security.entity.Role">
		SELECT
		T.*
		FROM TPL_APP_ROLE_T T
		<filter open="where (" close=")" />
	</select>

	<select id="select"
		resultType="io.jalorx.security.entity.Role" pageable="true">
		SELECT
		T.*
		FROM TPL_APP_ROLE_T T
		<filter open="where (" close=")" />
		ORDER BY T.ID
	</select>

	<sql id="base_insert_sql">
		INSERT INTO TPL_APP_ROLE_T
		(
		<if test="id != null">ID,</if>
		NAME, DESP, STATUS,CODE,
		TENANT_ID,APP_NAME,APP_SCOPE)
		VALUES
		(
		<if test="id != null">#{id,jdbcType=NUMERIC},</if>
		#{name}, #{desp}, #{status},#{code},
		#{tenantId,jdbcType=VARCHAR},#{appName,jdbcType=VARCHAR},#{appScope,jdbcType=VARCHAR})
	</sql>

	<insert id="insert"
		parameterType="io.jalorx.security.entity.Role"
		useGeneratedKeys="true" keyColumn="ID" keyProperty="id">
		<selectKey resultType="long" keyProperty="id" order="BEFORE"
			databaseId="oracle">
			SELECT TPL_APP_ROLE_S.NEXTVAL AS value FROM dual
		</selectKey>
		<include refid="base_insert_sql" />
	</insert>

	<update id="update"
		parameterType="io.jalorx.security.entity.Role">
		UPDATE TPL_APP_ROLE_T SET
		NAME = #{name},
		DESP = #{desp},
		STATUS = #{status},
		CODE = #{code}
		WHERE ID = #{id,jdbcType=NUMERIC}
	</update>

	<!-- 角色删除，批量删除拆分 -->
	<delete id="deleteById">
		DELETE FROM TPL_APP_ROLE_T WHERE ID=#{id}
	</delete>
	
	<delete id="deleteByIds">
		DELETE FROM TPL_APP_ROLE_T
		WHERE ID in
		<foreach item="id" collection="ids" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</delete>

	<delete id="deleteRolePermsById">
		DELETE FROM TPL_APP_ROLE_PERMS_T WHERE ROLE_ID=#{id}
	</delete>

	<!-- //////////////////////////////////////////////////////////// -->

	<insert id="insertRoleUsers" databaseId="mysql">
		INSERT INTO TPL_USER_ROLE_T(USER_ID,ROLE_ID) VALUES
		<foreach item="userId" collection="userIds" separator=",">
			(#{userId}, #{roleId})
		</foreach>
	</insert>
	<insert id="insertRoleUsers" databaseId="sqlserver">
		INSERT INTO TPL_USER_ROLE_T(USER_ID,ROLE_ID) VALUES
		<foreach item="userId" collection="userIds" separator=",">
			(#{userId}, #{roleId})
		</foreach>
	</insert>
	<insert id="insertRoleUsers" databaseId="oracle">
		INSERT INTO TPL_USER_ROLE_T(USER_ID,ROLE_ID)
		<foreach item="userId" collection="userIds" separator="union">
			(SELECT #{userId}, #{roleId} FROM DUAL)
		</foreach>
	</insert>

	<select id="findRoleByUserId" resultType="int">
		SELECT
		T.ROLE_ID
		FROM TPL_USER_ROLE_T T
		WHERE T.USER_ID = #{userId}
	</select>
	
	<select id="findRuntimeRolesByUserId" resultMap="RuntimeRoleResultMap">
		select
		 T.ROLE_ID,
		 T.DATA_ID
		from TPL_USER_ROLE_T T,TPL_APP_DATA_ROLE_T DR,TPL_APP_ROLE_T R
		where 
		 T.ROLE_ID=R.ID 
		 and T.DATA_ID=DR.ID 
		 and R.STATUS=1 
		 and DR.STATUS=1 
		 and T.USER_ID=#{userId}
		 and (T.START_TIME is null or T.START_TIME &lt;= #{_currentDate,jdbcType=DATE})
		 and (T.END_TIME is null or T.END_TIME &gt;= #{_currentDate,jdbcType=DATE})
	</select>
	
	<select id="getUsersByRoleId" resultType="Long">
		SELECT
		T.USER_ID
		FROM TPL_USER_ROLE_T T
		WHERE T.ROLE_ID = #{roleId}
	</select>

	<delete id="delRoleUsersByIds">
		DELETE FROM TPL_USER_ROLE_T
		WHERE ROLE_ID = #{id} and USER_ID in
		<foreach item="userId" collection="userIds" open="("
			separator="," close=")">
			#{userId}
		</foreach>
	</delete>
</mapper>

