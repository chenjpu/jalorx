<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.jalorx.security.dao.GroupDao">

	<!-- <cache /> -->

	<!-- ///////////////////////////基础接口定义///////////////////////////////// -->

	<select id="getById"
		resultType="io.jalorx.security.entity.Group">
		SELECT
		T.*
		FROM tpl_app_group_t T
		WHERE T.ID = #{id}
	</select>

	<select id="getByIds"
		resultType="io.jalorx.security.entity.Group">
		SELECT
		T.*
		FROM tpl_app_group_t T
		WHERE T.ID in
		<foreach item="id" collection="ids" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</select>

	<select id="getCount" resultType="int">
		SELECT
		count(1)
		FROM tpl_app_group_t T
		<filter open="where (" close=")" />
	</select>

	<select id="selectAll"
		resultType="io.jalorx.security.entity.Group">
		SELECT
		T.*
		FROM tpl_app_group_t T
		<filter open="where (" close=")" />
	</select>

	<select id="select"
		resultType="io.jalorx.security.entity.Group"
		pageable="true">
		SELECT T.* FROM tpl_app_group_t T
		<filter open="where (" close=")" />
		ORDER BY T.ID
	</select>

	<sql id="base_insert_sql">
		INSERT INTO TPL_APP_GROUP_T
		(
		<if test="id != null">ID,</if>
		CODE ,NAME,DESP,STATUS,DEFAULTIN , TYPE,
		TENANT_ID,APP_NAME,APP_SCOPE,
		REVISION,CREATE_USER_ID,LAST_UPDATE_USER_ID,CREATE_DATE,LAST_UPDATE_DATE)
		VALUES
		(
		<if test="id != null">#{id,jdbcType=NUMERIC},</if>
		#{code,jdbcType=VARCHAR},#{name,jdbcType=VARCHAR},#{desp,jdbcType=VARCHAR},#{status,jdbcType=NUMERIC},#{defaultIn,jdbcType=NUMERIC},#{type,jdbcType=VARCHAR},
		#{tenantId,jdbcType=VARCHAR},#{appName,jdbcType=VARCHAR},#{appScope,jdbcType=VARCHAR},
		#{revision,jdbcType=NUMERIC},#{currentUserId,jdbcType=NUMERIC},#{currentUserId,jdbcType=NUMERIC},#{_currentDate},#{_currentDate})
	</sql>
	<insert id="insert"
		parameterType="io.jalorx.security.entity.Group"
		useGeneratedKeys="true" keyColumn="ID" keyProperty="id">
		<selectKey resultType="long" keyProperty="id" order="BEFORE"
			databaseId="oracle">
			SELECT TPL_APP_GROUP_S.NEXTVAL AS value FROM dual
		</selectKey>
		<include refid="base_insert_sql" />
	</insert>

	<update id="update"
		parameterType="io.jalorx.security.entity.Group">
		UPDATE TPL_APP_GROUP_T SET
		CODE =
		#{code,jdbcType=VARCHAR},
		NAME = #{name,jdbcType=VARCHAR},
		DESP =
		#{desp,jdbcType=VARCHAR},
		STATUS = #{status,jdbcType=NUMERIC},
		DEFAULTIN = #{defaultIn,jdbcType=NUMERIC},
		TYPE =
		#{type,jdbcType=VARCHAR},
		REVISION = #{revisionNext,jdbcType=NUMERIC},
		LAST_UPDATE_USER_ID = #{currentUserId,jdbcType=NUMERIC},
		LAST_UPDATE_DATE = #{_currentDate}
		WHERE ID = #{id,jdbcType=NUMERIC}
	</update>


	<delete id="deleteById">
		DELETE FROM tpl_app_group_t
		WHERE ID = #{id}
	</delete>

	<delete id="deleteByIds">
		DELETE FROM tpl_app_group_t
		WHERE ID in
		<foreach item="id" collection="ids" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</delete>

	<!-- //////////////////////////////////////////////////////////// -->
	<select id="findGroupByCode"
		resultType="io.jalorx.security.entity.Group">
		SELECT T.* FROM tpl_app_group_t T WHERE T.CODE = #{code}
	</select>



	<insert id="insertGroupUsers" databaseId="mysql">
		INSERT INTO tpl_user_group_t VALUES
		<foreach item="userId" collection="userIds" separator=",">
			(#{userId}, #{groupId})
		</foreach>
	</insert>
	<insert id="insertGroupUsers" databaseId="sqlserver">
		INSERT INTO tpl_user_group_t VALUES
		<foreach item="userId" collection="userIds" separator=",">
			(#{userId}, #{groupId})
		</foreach>
	</insert>
	<insert id="insertGroupUsers" databaseId="oracle">
		INSERT INTO tpl_user_group_t
		<foreach item="userId" collection="userIds" separator="union">
			(SELECT
			#{userId}, #{groupId} FROM DUAL)
		</foreach>
	</insert>

	<select id="getUsersByGroupId" resultType="Long">
		SELECT
		T.user_id
		FROM
		tpl_user_group_t T
		WHERE T.group_id = #{groupId}
	</select>

	<select id="getUserEmailsByGroupIds" resultType="String">
		SELECT
		u.EMAIL
		FROM tpl_user_group_t T
		INNER JOIN tpl_user_t u on u.ID=T.USER_ID
		WHERE T.group_id in
		<foreach item="groupId" collection="groupIds" open="("
			separator="," close=")">
			#{groupId}
		</foreach>
	</select>

	<select id="getGroupIdsByUserId" resultType="String">
		SELECT DISTINCT
		GROUP_ID FROM TPL_USER_GROUP_T WHERE USER_ID =
		#{userId,jdbcType=NUMERIC}
	</select>
	<select id="getGroupCodesByUserId" resultType="String">
		SELECT DISTINCT
		g.CODE FROM TPL_USER_GROUP_T t join TPL_APP_GROUP_T g on (t.GROUP_ID =
		G.ID) WHERE t.USER_ID = #{userId,jdbcType=NUMERIC}
	</select>

	<delete id="delGroupUsersByIds">
		DELETE FROM tpl_user_group_t
		WHERE group_id = #{id} and user_id in
		<foreach item="userId" collection="userIds" open="("
			separator="," close=")">
			#{userId}
		</foreach>
	</delete>
</mapper>

