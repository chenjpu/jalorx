<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.jalorx.security.dao.UserDao">

	<!-- <cache /> -->

	<!-- ///////////////////////////基础接口定义///////////////////////////////// -->

	<select id="getById"
		resultType="io.jalorx.security.entity.User">
		SELECT
		T.*
		FROM TPL_USER_T T
		WHERE T.ID = #{id}
		<if test="_tenantId != null">
			and T.TENANT_ID = #{_tenantId}
		</if>
	</select>
	<select id="getByIds"
		resultType="io.jalorx.security.entity.User">
		SELECT
		T.*
		FROM TPL_USER_T T
		WHERE T.ID in
		<foreach item="id" collection="ids" open="(" separator=","
			close=")">
			#{id}
		</foreach>
		<if test="_tenantId != null">
			and T.TENANT_ID = #{_tenantId}
		</if>
	</select>

	<select id="getCount" resultType="int">
		SELECT
		count(1)
		FROM TPL_USER_T T
		<filter open="where (" close=")" tenant="true" />
	</select>

	<select id="selectAll"
		resultType="io.jalorx.security.entity.User">
		SELECT
		T.*
		FROM TPL_USER_T T
		<filter open="where (" close=")" tenant="true" />
	</select>

	<select id="select"
		resultType="io.jalorx.security.entity.User" pageable="true">
		select T.* FROM TPL_USER_T T
		<filter open="where (" close=")" tenant="true" />
		ORDER BY T.ID
	</select>

	<!-- 插入语句 -->
	<sql id="base_insert_sql">
		INSERT INTO TPL_USER_T
		(
		<if test="id != null">ID,</if>
		EMAIL, LASTNAME, PASSWORD , STATUS, PHONE, ACOUNT
		,ORGINFO,LANGUAGE_CODE,BACK_UP,BACK_UP1,BACK_UP2,
		TENANT_ID,APP_NAME,APP_SCOPE,CREATE_DATE,LAST_UPDATE_DATE)
		VALUES
		(
		<if test="id != null">#{id,jdbcType=NUMERIC},</if>
		#{email,jdbcType=VARCHAR}, #{lastname,jdbcType=VARCHAR}, #{password},
		#{status},
		#{phone,jdbcType=VARCHAR}, #{acount,jdbcType=VARCHAR} ,
		#{orginfo,jdbcType=VARCHAR},#{languageCode,jdbcType=VARCHAR},#{backUp,jdbcType=VARCHAR},#{backUp1,jdbcType=VARCHAR},#{backUp2,jdbcType=VARCHAR},
		#{_tenantId,jdbcType=VARCHAR},#{appName,jdbcType=VARCHAR},#{appScope,jdbcType=VARCHAR},#{_currentDate},#{_currentDate})
	</sql>
	<insert id="insert"
		parameterType="io.jalorx.security.entity.User"
		useGeneratedKeys="true" keyColumn="ID" keyProperty="id">
		<selectKey resultType="long" keyProperty="id" order="BEFORE"
			databaseId="oracle">
			SELECT TPL_USER_S.NEXTVAL AS value FROM dual
		</selectKey>
		<include refid="base_insert_sql" />
	</insert>

	<update id="update"
		parameterType="io.jalorx.security.entity.User">
		UPDATE tpl_user_t SET
		EMAIL = #{email},
		LASTNAME = #{lastname},
		STATUS =
		#{status},
		PHONE = #{phone},
		ACOUNT = #{acount,jdbcType=VARCHAR},
		ORGINFO = #{orginfo,jdbcType=VARCHAR},
		LANGUAGE_CODE =
		#{languageCode,jdbcType=VARCHAR},
		BACK_UP=#{backUp,jdbcType=VARCHAR},
		BACK_UP1=#{backUp1,jdbcType=VARCHAR},
		BACK_UP2=#{backUp2,jdbcType=VARCHAR},
		LAST_UPDATE_DATE =
		#{_currentDate}
		WHERE ID = #{id,jdbcType=NUMERIC}
		<if test="_tenantId != null">
			and TENANT_ID = #{_tenantId}
		</if>
	</update>

	<update id="modifyAccount"
		parameterType="io.jalorx.security.entity.User">
		UPDATE tpl_user_t
		<set>
			<if test="languageCode != null"> LANGUAGE_CODE = #{languageCode},
			</if>
		</set>
		WHERE ID = #{id,jdbcType=NUMERIC}
		<if test="_tenantId != null">
			and TENANT_ID = #{_tenantId}
		</if>
	</update>

	<update id="modifyPsw">
		UPDATE tpl_user_t SET
		PASSWORD = #{password,jdbcType=VARCHAR}
		WHERE ID =
		#{currentUserId,jdbcType=NUMERIC}
		<if test="_tenantId != null">
			and TENANT_ID = #{_tenantId}
		</if>
	</update>

	<delete id="deleteById">
		DELETE FROM TPL_USER_T
		WHERE ID = #{id}
		<if test="_tenantId != null">
			and TENANT_ID = #{_tenantId}
		</if>
	</delete>

	<delete id="deleteByIds">
		DELETE FROM TPL_USER_T
		WHERE ID in
		<foreach item="id" collection="ids" open="(" separator=","
			close=")">
			#{id}
		</foreach>
	</delete>

	<!-- //////////////////////////////////////////////////////////// -->

	<insert id="insertUserRoles" databaseId="mysql">
		INSERT INTO TPL_USER_ROLE_T VALUES
		<foreach item="roleId" collection="roleIds" separator=",">
			(#{userId}, #{roleId})
		</foreach>
	</insert>
	<insert id="insertUserRoles" databaseId="sqlserver">
		INSERT INTO TPL_USER_ROLE_T VALUES
		<foreach item="roleId" collection="roleIds" separator=",">
			(#{userId}, #{roleId})
		</foreach>
	</insert>
	<insert id="insertUserRoles" databaseId="oracle">
		INSERT INTO TPL_USER_ROLE_T
		<foreach item="roleId" collection="roleIds" separator="union">
			(SELECT
			#{userId}, #{roleId} FROM DUAL)
		</foreach>
	</insert>

	<delete id="delRolesByUserId">
		DELETE FROM TPL_USER_ROLE_T
		WHERE USER_ID = #{id}
	</delete>

	<select id="getRolesByUserId" resultType="Long">
		SELECT
		T.ROLE_ID
		FROM
		TPL_USER_ROLE_T T
		WHERE T.USER_ID = #{userId}
	</select>

	<select id="findByUserAcount"
		resultType="io.jalorx.security.entity.User">
		SELECT
		T.*
		FROM
		TPL_USER_T T
		WHERE T.ACOUNT = #{acount}
	</select>
	<delete id="delUserRolesByIds">
		DELETE FROM TPL_USER_ROLE_T
		WHERE USER_ID = #{id} and ROLE_ID in
		<foreach item="roleId" collection="roleIds" open="("
			separator="," close=")">
			#{roleId}
		</foreach>
	</delete>
</mapper>

